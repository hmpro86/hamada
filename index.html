<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</title>

  <!-- Ø®Ø· Ø¹Ø±Ø¨ÙŠ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg1:#0b1220;
      --bg2:#0f1a33;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.14);
      --text:#eef2ff;
      --muted: rgba(238,242,255,.72);
      --accent:#7c3aed;
      --accent2:#06b6d4;
      --ok:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(800px 500px at 90% 20%, rgba(6,182,212,.25), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .app{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 16px 80px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding: 12px 12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      position: sticky;
      top: 12px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 260px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display:grid;place-items:center;
      box-shadow: 0 10px 25px rgba(124,58,237,.25);
      border:1px solid rgba(255,255,255,.22);
    }
    .logo svg{filter:drop-shadow(0 6px 10px rgba(0,0,0,.25))}
    .brand h1{
      margin:0;
      font-size: 16.5px;
      font-weight: 800;
      letter-spacing: .2px;
      line-height:1.2;
    }
    .brand .sub{
      margin:0;
      color: var(--muted);
      font-size: 12.5px;
      font-weight: 500;
    }

    .right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color: var(--muted);
      font-size: 12.5px;
      font-weight: 600;
      white-space:nowrap;
    }
    .chip strong{color:var(--text); font-weight:800}
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.11); border-color: rgba(255,255,255,.22)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.7));
      border-color: rgba(255,255,255,.22);
    }
    .btn.danger{background: rgba(239,68,68,.14); border-color: rgba(239,68,68,.35)}
    .btn.ok{background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.32)}
    .btn.warn{background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.32)}

    .tabs{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius: var(--r);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(10px);
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid transparent;
      background: rgba(255,255,255,.06);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      color: var(--muted);
      transition: all .15s ease;
    }
    .tab:hover{transform: translateY(-1px); color: var(--text); background: rgba(255,255,255,.09)}
    .tab.active{
      background: linear-gradient(135deg, rgba(124,58,237,.55), rgba(6,182,212,.35));
      color: var(--text);
      border-color: rgba(255,255,255,.18);
      box-shadow: 0 12px 28px rgba(124,58,237,.18);
    }

    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius: var(--r);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      animation: fadeUp .45s ease both;
    }
    @keyframes fadeUp {from{opacity:0; transform: translateY(6px)} to{opacity:1; transform: translateY(0)}}

    .card h2{
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 900;
    }
    .muted{color: var(--muted)}

    .kpis{
      display:grid;
      grid-template-columns: repeat(4,1fr);
      gap: 12px;
    }
    @media (max-width: 980px){ .kpis{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 520px){ .kpis{grid-template-columns: 1fr} }

    .kpi{
      padding: 12px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      position: relative;
      overflow:hidden;
    }
    .kpi::before{
      content:"";
      position:absolute; inset:-40px auto auto -40px;
      width: 120px; height:120px;
      background: radial-gradient(circle at 30% 30%, rgba(124,58,237,.35), transparent 60%);
      transform: rotate(20deg);
      pointer-events:none;
    }
    .kpi .label{font-size: 12.5px; color: var(--muted); font-weight: 700}
    .kpi .value{font-size: 26px; font-weight: 1000; margin-top: 4px}
    .kpi .hint{font-size: 12px; color: var(--muted); margin-top: 6px}

    .row{
      display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 160px;
      flex: 1;
    }
    label{font-size: 12.5px; color: var(--muted); font-weight: 700}
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border:1px solid var(--stroke);
      background: rgba(15, 23, 42, .35);
      color: var(--text);
      outline:none;
      font-family: inherit;
      font-weight: 650;
    }
    input::placeholder, textarea::placeholder{color: rgba(238,242,255,.45); font-weight:600}
    textarea{min-height: 90px; resize: vertical}

    .tableWrap{
      margin-top: 10px;
      border:1px solid var(--stroke);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.04);
    }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:right;
      vertical-align:middle;
    }
    th{
      color: rgba(238,242,255,.85);
      font-weight: 900;
      background: rgba(255,255,255,.06);
    }
    tr:hover td{background: rgba(255,255,255,.04)}
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      font-size: 12px;
      font-weight: 900;
      color: var(--text);
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12)}
    .tag.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12)}
    .tag.warn{border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12)}

    .section{
      display:none;
      margin-top: 14px;
    }
    .section.active{display:block}

    footer{
      position: fixed;
      inset: auto 0 0 0;
      padding: 12px 16px;
      background: rgba(5,10,20,.55);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      z-index: 50;
    }
    footer .inner{
      max-width: 1280px;
      margin: 0 auto;
      display:flex; justify-content:space-between; align-items:center;
      gap: 10px;
      flex-wrap:wrap;
      color: rgba(238,242,255,.78);
      font-weight: 800;
      font-size: 12.5px;
    }

    /* Dialog */
    dialog{
      width: min(720px, 94vw);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.90));
      color: var(--text);
      box-shadow: 0 50px 120px rgba(0,0,0,.6);
      padding: 0;
      overflow: hidden;
    }
    dialog::backdrop{
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(4px);
    }
    .dlgHead{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .dlgTitle{font-weight: 1000; font-size: 14px}
    .dlgBody{padding: 14px}
    .dlgActions{
      padding: 12px 14px 14px;
      display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }

    /* ØµØºÙŠØ±: ØªÙ…Ø±ÙŠØ± Ø£ÙÙ‚ÙŠ Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    .tableScroll{overflow:auto}
    .hintSmall{font-size:12.2px;color:var(--muted);line-height:1.55}
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M12 2l8.5 4.6v10.8L12 22l-8.5-4.6V6.6L12 2z" stroke="rgba(255,255,255,.92)" stroke-width="1.8"/>
            <path d="M7.2 12.2l3.0 3.0 6.6-6.6" stroke="rgba(255,255,255,.92)" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1>Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©</h1>
          <p class="sub">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª ÙˆØ§Ù„Ø·Ø§Ù„Ø¨Ø§Øª â€¢ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ â€¢ ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ©</p>
        </div>
      </div>

      <div class="right">
        <div class="chip" title="ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±ÙŠØ§Ø¶">
          <span>ğŸ“…</span>
          <span id="nowDate">â€”</span>
          <span>â±ï¸</span>
          <strong id="nowTime">â€”</strong>
        </div>
        <button class="btn ok" id="btnQuickAdd">Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button>
        <button class="btn warn" id="btnBackup">ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© (JSON)</button>
        <button class="btn" id="btnRestore">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©</button>
        <button class="btn danger" id="btnReset">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
      </div>
    </div>

    <div class="tabs" role="tablist" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
      <button class="tab active" data-tab="home" role="tab" aria-selected="true">ğŸ« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
      <button class="tab" data-tab="teachers" role="tab">ğŸ‘©â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</button>
      <button class="tab" data-tab="students" role="tab">ğŸ‘©â€ğŸ“ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</button>
      <button class="tab" data-tab="attendance" role="tab">âœ… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</button>
      <button class="tab" data-tab="reports" role="tab">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
      <button class="tab" data-tab="settings" role="tab">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
    </div>

    <!-- ============ HOME ============ -->
    <section class="section active" id="home">
      <div class="grid">
        <div class="card">
          <h2>Ù…Ù„Ø®Øµ ÙÙˆØ±ÙŠ</h2>
          <div class="kpis">
            <div class="kpi">
              <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</div>
              <div class="value" id="kpiTeachers">0</div>
              <div class="hint">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</div>
            </div>
            <div class="kpi">
              <div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</div>
              <div class="value" id="kpiStudents">0</div>
              <div class="hint">Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„/Ø­Ø°Ù Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</div>
            </div>
            <div class="kpi">
              <div class="label">Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="value" id="kpiPresent">0</div>
              <div class="hint">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨</div>
            </div>
            <div class="kpi">
              <div class="label">ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
              <div class="value" id="kpiAbsent">0</div>
              <div class="hint">ÙŠØ´Ù…Ù„ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±/Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</div>
            </div>
          </div>

          <div style="margin-top:14px" class="row">
            <div class="field">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ© Ø³Ø±ÙŠØ¹Ø©</label>
              <textarea id="adminNote" placeholder="Ø§ÙƒØªØ¨ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø©... (ØªØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)"></textarea>
              <div class="hintSmall">ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (localStorage).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Ù„ÙˆØ­Ø© Ø§Ù„ÙŠÙˆÙ…</h2>
          <div class="row">
            <div class="field">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</label>
              <input id="todayISO" disabled />
            </div>
            <div class="field">
              <label>Ø§Ù„ÙŠÙˆÙ…</label>
              <input id="todayName" disabled />
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <div class="field">
              <label>Ù†Ø³Ø¨Ø© Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…</label>
              <input id="todayRate" disabled />
            </div>
          </div>

          <div style="margin-top:12px">
            <canvas id="chartToday" height="150"></canvas>
          </div>

          <div style="margin-top:10px" class="hintSmall">
            Ø§Ù„Ø±Ø³Ù… ÙŠØ¹Ø±Ø¶ ØªÙˆØ²ÙŠØ¹ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ <b>Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ</b> Ø­Ø³Ø¨ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„.
          </div>
        </div>
      </div>
    </section>

    <!-- ============ TEACHERS ============ -->
    <section class="section" id="teachers">
      <div class="card">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª</h2>

        <div class="row">
          <div class="field"><label>Ø§Ù„Ø§Ø³Ù…</label><input id="tName" placeholder="Ù…Ø«Ø§Ù„: Ø£. Ù†ÙˆØ±Ø© Ø£Ø­Ù…Ø¯" /></div>
          <div class="field"><label>Ø§Ù„ØªØ®ØµØµ</label><input id="tSubject" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠØ§Ø¶ÙŠØ§Øª" /></div>
          <div class="field"><label>Ø§Ù„Ø¬ÙˆØ§Ù„</label><input id="tPhone" placeholder="05xxxxxxxx" /></div>
          <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯</label><input id="tEmail" placeholder="name@school.edu" /></div>
        </div>

        <div style="margin-top:10px" class="row">
          <button class="btn primary" id="tAdd">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…Ø©</button>
          <button class="btn" id="tClear">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="chip">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong id="tCount">0</strong></div>
        </div>

        <div class="tableWrap tableScroll" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØ®ØµØµ</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="tTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ============ STUDENTS ============ -->
    <section class="section" id="students">
      <div class="card">
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª</h2>

        <div class="row">
          <div class="field"><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©</label><input id="sName" placeholder="Ù…Ø«Ø§Ù„: Ø±ÙŠÙ… Ù…Ø­Ù…Ø¯" /></div>
          <div class="field">
            <label>Ø§Ù„ØµÙ</label>
            <select id="sGrade">
              <option value="">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØµÙ</option>
              <option>Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„Ø«Ø§Ù„Ø«</option>
              <option>Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„Ø³Ø§Ø¯Ø³</option>
              <option>Ø§Ù„Ø£ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option><option>Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
              <option>Ø§Ù„Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option><option>Ø§Ù„Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option><option>Ø§Ù„Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
            </select>
          </div>
          <div class="field"><label>Ø§Ù„ÙØµÙ„</label><input id="sClass" placeholder="Ù…Ø«Ø§Ù„: 2/Ø¨" /></div>
          <div class="field"><label>Ù‡ÙˆÙŠØ©/Ø±Ù‚Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="sId" placeholder="Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©/Ø³Ø¬Ù„" /></div>
        </div>

        <div style="margin-top:10px" class="row">
          <button class="btn primary" id="sAdd">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨Ø©</button>
          <button class="btn" id="sClear">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
          <div class="chip">Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong id="sCount">0</strong></div>
        </div>

        <div class="tableWrap tableScroll" style="margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„ÙØµÙ„</th><th>Ù‡ÙˆÙŠØ©/Ø±Ù‚Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="sTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ============ ATTENDANCE ============ -->
    <section class="section" id="attendance">
      <div class="grid">
        <div class="card">
          <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨ Ø§Ù„ÙŠÙˆÙ…</h2>

          <div class="row">
            <div class="field">
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input id="aDate" />
            </div>
            <div class="field">
              <label>Ø§Ù„ØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="aGrade" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø³Ø§Ø¯Ø³ / Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·..." />
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <div class="field">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              <input id="aPresent" type="number" min="0" placeholder="0" />
            </div>
            <div class="field">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±</label>
              <input id="aAbsentExcused" type="number" min="0" placeholder="0" />
            </div>
            <div class="field">
              <label>Ø¹Ø¯Ø¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</label>
              <input id="aAbsentUnexcused" type="number" min="0" placeholder="0" />
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <div class="field">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="aNote" placeholder="Ù…Ø«Ø§Ù„: ØºÙŠØ§Ø¨ Ø¨Ø³Ø¨Ø¨ Ø¸Ø±Ù Ø·Ø§Ø±Ø¦..." />
            </div>
          </div>

          <div style="margin-top:10px" class="row">
            <button class="btn primary" id="aSave">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
            <button class="btn" id="aClear">ØªÙØ±ÙŠØº</button>
            <div class="chip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª: <strong id="aCount">0</strong></div>
          </div>

          <div class="tableWrap tableScroll" style="margin-top:12px">
            <table>
              <thead>
                <tr>
                  <th>#</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ØµÙ</th><th>Ø­Ø¶ÙˆØ±</th><th>ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±</th><th>ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="aTable"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h2>
          <canvas id="chartAttendance" height="170"></canvas>
          <div style="margin-top:10px" class="hintSmall">
            ÙŠØ¹Ø±Ø¶ Ø£Ø­Ø¯Ø« Ø³Ø¬Ù„ Ù„Ù†ÙØ³ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… (Ø¥Ù† ÙˆÙØ¬Ø¯)ØŒ ÙˆØ¥Ù„Ø§ ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± Ø³Ø¬Ù„ Ù…Ø­ÙÙˆØ¸.
          </div>

          <div style="margin-top:12px" class="row">
            <button class="btn ok" id="btnOpenTips">Ù†ØµØ§Ø¦Ø­ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø·</button>
            <button class="btn" id="btnOpenAbout">Ø¹Ù† Ø§Ù„Ù„ÙˆØ­Ø©</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ REPORTS ============ -->
    <section class="section" id="reports">
      <div class="grid">
        <div class="card">
          <h2>Ø¥Ø­ØµØ§Ø¡Ø§Øª Ø¹Ø§Ù…Ø©</h2>
          <div class="kpis">
            <div class="kpi">
              <div class="label">Ù…ØªÙˆØ³Ø· Ø­Ø¶ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
              <div class="value" id="kpiAvgPresent">0</div>
              <div class="hint">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¶ÙˆØ± Ø¹Ø¨Ø± ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</div>
            </div>
            <div class="kpi">
              <div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØºÙŠØ§Ø¨</div>
              <div class="value" id="kpiAvgAbsent">0</div>
              <div class="hint">Ø¨Ø¹Ø°Ø± + Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</div>
            </div>
            <div class="kpi">
              <div class="label">Ø£Ø¹Ù„Ù‰ Ø­Ø¶ÙˆØ±</div>
              <div class="value" id="kpiMaxPresent">0</div>
              <div class="hint">Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© Ø­Ø¶ÙˆØ± Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
            <div class="kpi">
              <div class="label">Ø£Ø¹Ù„Ù‰ ØºÙŠØ§Ø¨</div>
              <div class="value" id="kpiMaxAbsent">0</div>
              <div class="hint">Ø£Ø¹Ù„Ù‰ Ù‚ÙŠÙ…Ø© ØºÙŠØ§Ø¨ Ù…Ø³Ø¬Ù„Ø©</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <canvas id="chartTrend" height="170"></canvas>
          </div>
          <div style="margin-top:10px" class="hintSmall">
            Ø§Ù„Ø±Ø³Ù… ÙŠØ¹Ø±Ø¶ Ø¢Ø®Ø± 14 Ø³Ø¬Ù„Ù‹Ø§ (ØªØ³Ù„Ø³Ù„ Ø²Ù…Ù†ÙŠ Ù…Ø¨Ø³Ø·) Ù„ØªØªØ¨Ù‘Ø¹ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨.
          </div>
        </div>

        <div class="card">
          <h2>ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠØ¹ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©</h2>
          <div class="row">
            <button class="btn primary" id="btnPrint">Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
            <button class="btn" id="btnCSV">ØªØµØ¯ÙŠØ± CSV (Ø§Ù„Ø­Ø¶ÙˆØ±)</button>
          </div>

          <div style="margin-top:12px" class="hintSmall">
            Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø·Ø¨Ø§Ø¹Ø©: Ø³ÙŠØ¸Ù‡Ø± ØªÙ‚Ø±ÙŠØ± Ù…Ø®ØªØµØ± ÙŠØªØ¶Ù…Ù† Ø£Ù‡Ù… Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ….  
            ÙˆÙŠÙ…ÙƒÙ† Ø­ÙØ¸Ù‡ ÙƒÙ€ PDF Ù…Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©.
          </div>

          <div style="margin-top:12px" class="tableWrap">
            <div style="padding:12px">
              <div class="hintSmall" id="reportText">â€”</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ SETTINGS ============ -->
    <section class="section" id="settings">
      <div class="card">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙ…Ø²Ø§ÙŠØ§ Ø¥Ø¶Ø§ÙÙŠØ©</h2>

        <div class="row">
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)</label>
            <input id="schoolName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù‡Ù†Ø§..." />
          </div>
          <div class="field">
            <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
            <select id="schoolStage">
              <option value="">Ø§Ø®ØªØ§Ø±ÙŠ</option>
              <option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©</option><option>Ù…ØªÙˆØ³Ø·Ø©</option><option>Ø«Ø§Ù†ÙˆÙŠØ©</option><option>Ù…Ø¬Ù…Ø¹</option>
            </select>
          </div>
          <div class="field">
            <label>Ø¹Ø§Ù… Ø¯Ø±Ø§Ø³ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="schoolYear" placeholder="1447Ù‡Ù€ / 2026Ù…" />
          </div>
        </div>

        <div style="margin-top:10px" class="row">
          <button class="btn ok" id="btnSaveSettings">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          <button class="btn" id="btnDemoData">ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
        </div>

        <div style="margin-top:12px" class="tableWrap">
          <div style="padding:12px">
            <div class="hintSmall">
              â€¢ Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙŠØªÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Storage (localStorage).  
              â€¢ ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ø¨Ø± ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON.  
              â€¢ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ØªØ³ØªØ®Ø¯Ù… Ø¹Ù†ØµØ± &lt;dialog&gt; Ø§Ù„Ù…Ø¯Ù…Ø¬ Ø¨Ø§Ù„Ù…ØªØµÙØ­.
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- ======= Dialogs ======= -->
  <dialog id="dlgQuick">
    <div class="dlgHead">
      <div class="dlgTitle">Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</div>
      <button class="btn" onclick="document.getElementById('dlgQuick').close()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="dlgBody">
      <div class="row">
        <button class="btn primary" id="qaTeacher">+ Ù…Ø¹Ù„Ù…Ø©</button>
        <button class="btn primary" id="qaStudent">+ Ø·Ø§Ù„Ø¨Ø©</button>
        <button class="btn primary" id="qaAttendance">+ Ø­Ø¶ÙˆØ±/ØºÙŠØ§Ø¨</button>
      </div>
      <div style="margin-top:10px" class="hintSmall">
        ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ø«Ù… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
      </div>
    </div>
    <div class="dlgActions">
      <button class="btn" onclick="document.getElementById('dlgQuick').close()">ØªÙ…</button>
    </div>
  </dialog>

  <dialog id="dlgTips">
    <div class="dlgHead">
      <div class="dlgTitle">Ù†ØµØ§Ø¦Ø­ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</div>
      <button class="btn" onclick="document.getElementById('dlgTips').close()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="dlgBody">
      <div class="hintSmall">
        1) ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡ ÙŠÙˆÙ…ÙŠ Ù„Ù„ØµÙÙˆÙ Ø°Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø±ØªÙØ¹.<br>
        2) Ø±Ø¨Ø· Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø®Ø·Ø© ØªØ­ÙÙŠØ² (Ø´Ù‡Ø§Ø¯Ø§Øª/Ù†Ù‚Ø§Ø·/ØªÙƒØ±ÙŠÙ…).<br>
        3) Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø± ÙØ±Ø¯ÙŠÙ‹Ø§ Ù…Ø¹ Ø§Ù„Ù…Ø±Ø´Ø¯Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ÙŠØ© ÙˆÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±.<br>
        4) ØªØ­Ù„ÙŠÙ„ Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§ ÙˆØªÙˆØ«ÙŠÙ‚Ù‡Ø§ ÙÙŠ â€œÙ…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø³Ø¬Ù„â€.<br>
        5) Ù†Ø´Ø± Ù„ÙˆØ­Ø© Ø´ÙØ§ÙØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ: Ù†Ø³Ø¨Ø© Ø­Ø¶ÙˆØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ÙˆØªÙ‚Ø¯Ù…Ù‡Ø§.
      </div>
    </div>
    <div class="dlgActions">
      <button class="btn ok" onclick="document.getElementById('dlgTips').close()">Ø­Ø³Ù†Ù‹Ø§</button>
    </div>
  </dialog>

  <dialog id="dlgAbout">
    <div class="dlgHead">
      <div class="dlgTitle">Ø¹Ù† Ø§Ù„Ù„ÙˆØ­Ø©</div>
      <button class="btn" onclick="document.getElementById('dlgAbout').close()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="dlgBody">
      <div class="hintSmall" id="aboutText">â€”</div>
    </div>
    <div class="dlgActions">
      <button class="btn ok" onclick="document.getElementById('dlgAbout').close()">ØªÙ…</button>
    </div>
  </dialog>

  <input id="fileInput" type="file" accept="application/json" hidden />

  <footer>
    <div class="inner">
      <div id="footerSchool">â€”</div>
      <div>Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ù…Ø§Ø¯Ù‡ Ø®Ù„ÙŠÙ„</div>
    </div>
  </footer>

  <script>
    /***********************
     * Storage & Utilities
     ***********************/
    const STORAGE_KEY = "school_kpi_dashboard_v1";

    const RiyadhTZ = "Asia/Riyadh";

    function fmtNow() {
      const d = new Date();
      const date = new Intl.DateTimeFormat("ar-SA", {
        timeZone: RiyadhTZ,
        weekday: "long",
        year: "numeric",
        month: "long",
        day: "numeric"
      }).format(d);

      const time = new Intl.DateTimeFormat("ar-SA", {
        timeZone: RiyadhTZ,
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit"
      }).format(d);

      return { date, time };
    }

    function todayISO_Riyadh(){
      const parts = new Intl.DateTimeFormat("en-CA", { timeZone: RiyadhTZ, year:"numeric", month:"2-digit", day:"2-digit" }).formatToParts(new Date());
      const y = parts.find(p=>p.type==="year").value;
      const m = parts.find(p=>p.type==="month").value;
      const d = parts.find(p=>p.type==="day").value;
      return `${y}-${m}-${d}`;
    }

    function safeParseInt(v){ const n = parseInt(v,10); return Number.isFinite(n) ? n : 0; }

    function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }

    function toCSV(rows){
      const esc = (s)=> `"${String(s ?? "").replaceAll('"','""')}"`;
      return rows.map(r=> r.map(esc).join(",")).join("\n");
    }

    /***********************
     * App State
     ***********************/
    const defaultState = {
      settings: { schoolName:"", schoolStage:"", schoolYear:"" },
      adminNote: "",
      teachers: [],
      students: [],
      attendance: [] // {id, dateISO, grade, present, absentExcused, absentUnexcused, note, createdAt}
    };

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...parsed,
          settings: { ...defaultState.settings, ...(parsed.settings||{}) }
        };
      }catch(e){
        return structuredClone(defaultState);
      }
    }

    function saveState(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    /***********************
     * Tabs
     ***********************/
    const tabs = Array.from(document.querySelectorAll(".tab"));
    const sections = {
      home: document.getElementById("home"),
      teachers: document.getElementById("teachers"),
      students: document.getElementById("students"),
      attendance: document.getElementById("attendance"),
      reports: document.getElementById("reports"),
      settings: document.getElementById("settings")
    };

    function setTab(key){
      tabs.forEach(t=>{
        const active = t.dataset.tab === key;
        t.classList.toggle("active", active);
        t.setAttribute("aria-selected", active ? "true" : "false");
      });
      Object.entries(sections).forEach(([k, el])=>{
        el.classList.toggle("active", k === key);
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… ÙˆØ§Ù„Ù…Ù„Ø®Øµ Ø¹Ù†Ø¯ ÙØªØ­ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¹ÙŠÙ†Ø©
      if(key==="home"){ refreshAll(); }
      if(key==="attendance"){ refreshAttendance(); }
      if(key==="reports"){ refreshReports(); }
      if(key==="settings"){ refreshSettingsUI(); }
    }

    tabs.forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));

    /***********************
     * Time
     ***********************/
    function tickClock(){
      const {date, time} = fmtNow();
      document.getElementById("nowDate").textContent = date;
      document.getElementById("nowTime").textContent = time;

      const iso = todayISO_Riyadh();
      document.getElementById("todayISO").value = iso;
      document.getElementById("aDate").value = iso;

      const dayName = new Intl.DateTimeFormat("ar-SA", { timeZone:RiyadhTZ, weekday:"long" }).format(new Date());
      document.getElementById("todayName").value = dayName;
    }
    setInterval(tickClock, 1000);
    tickClock();

    /***********************
     * Charts
     ***********************/
    let chartToday, chartAttendance, chartTrend;

    function makeDoughnut(ctx, labels, data){
      return new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{ data, borderWidth: 1.2 }]
        },
        options: {
          plugins: {
            legend: { position: "bottom", labels: { color: "#eef2ff", font: { family:"Tajawal" } } },
            tooltip: { enabled: true }
          }
        }
      });
    }

    function makeLine(ctx, labels, presentData, absentData){
      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Ø§Ù„Ø­Ø¶ÙˆØ±", data: presentData, tension: .35, fill: false, borderWidth: 2 },
            { label: "Ø§Ù„ØºÙŠØ§Ø¨", data: absentData, tension: .35, fill: false, borderWidth: 2 }
          ]
        },
        options: {
          plugins: {
            legend: { position: "bottom", labels: { color: "#eef2ff", font: { family:"Tajawal" } } }
          },
          scales: {
            x: { ticks: { color: "rgba(238,242,255,.8)", font:{ family:"Tajawal" } }, grid: { color:"rgba(255,255,255,.06)" } },
            y: { ticks: { color: "rgba(238,242,255,.8)", font:{ family:"Tajawal" } }, grid: { color:"rgba(255,255,255,.06)" } }
          }
        }
      });
    }

    function initCharts(){
      const ctx1 = document.getElementById("chartToday");
      const ctx2 = document.getElementById("chartAttendance");
      const ctx3 = document.getElementById("chartTrend");

      chartToday = makeDoughnut(ctx1, ["Ø­Ø¶ÙˆØ±", "ØºÙŠØ§Ø¨"], [0,0]);
      chartAttendance = makeDoughnut(ctx2, ["Ø­Ø¶ÙˆØ±", "ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±", "ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±"], [0,0,0]);
      chartTrend = makeLine(ctx3, [], [], []);
    }

    initCharts();

    function updateDoughnut(chart, data){
      chart.data.datasets[0].data = data;
      chart.update();
    }

    /***********************
     * Teachers CRUD
     ***********************/
    const tName = document.getElementById("tName");
    const tSubject = document.getElementById("tSubject");
    const tPhone = document.getElementById("tPhone");
    const tEmail = document.getElementById("tEmail");
    const tTable = document.getElementById("tTable");
    const tCount = document.getElementById("tCount");

    function clearTeacherForm(){
      tName.value=""; tSubject.value=""; tPhone.value=""; tEmail.value="";
      tName.focus();
    }

    function addTeacher(){
      const name = tName.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©."); return; }
      const teacher = {
        id: uid(),
        name,
        subject: tSubject.value.trim(),
        phone: tPhone.value.trim(),
        email: tEmail.value.trim()
      };
      state.teachers.unshift(teacher);
      saveState();
      clearTeacherForm();
      renderTeachers();
      refreshAll();
    }

    function renderTeachers(){
      tCount.textContent = state.teachers.length;
      tTable.innerHTML = "";
      state.teachers.forEach((t, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${t.name}</td>
          <td>${t.subject || "â€”"}</td>
          <td>${t.phone || "â€”"}</td>
          <td>${t.email || "â€”"}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${t.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger" data-act="del" data-id="${t.id}">Ø­Ø°Ù</button>
          </td>
        `;
        tTable.appendChild(tr);
      });
    }

    tTable.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;
      if(act==="del"){
        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ù„Ù…Ø©ØŸ")) return;
        state.teachers = state.teachers.filter(x=>x.id!==id);
        saveState();
        renderTeachers();
        refreshAll();
      }
      if(act==="edit"){
        const t = state.teachers.find(x=>x.id===id);
        if(!t) return;
        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙÙˆØ±Ù… Ø«Ù… Ø§Ù„Ø­ÙØ¸ ÙƒØªØ­Ø¯ÙŠØ«
        tName.value = t.name;
        tSubject.value = t.subject || "";
        tPhone.value = t.phone || "";
        tEmail.value = t.email || "";
        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ù‚ØªÙ‹Ø§
        const addBtn = document.getElementById("tAdd");
        addBtn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        addBtn.classList.add("warn");
        addBtn.onclick = ()=>{
          t.name = tName.value.trim() || t.name;
          t.subject = tSubject.value.trim();
          t.phone = tPhone.value.trim();
          t.email = tEmail.value.trim();
          saveState();
          renderTeachers();
          refreshAll();
          clearTeacherForm();
          addBtn.textContent = "Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„Ù…Ø©";
          addBtn.classList.remove("warn");
          addBtn.onclick = addTeacher;
        };
      }
    });

    document.getElementById("tAdd").onclick = addTeacher;
    document.getElementById("tClear").onclick = clearTeacherForm;

    /***********************
     * Students CRUD
     ***********************/
    const sName = document.getElementById("sName");
    const sGrade = document.getElementById("sGrade");
    const sClass = document.getElementById("sClass");
    const sId = document.getElementById("sId");
    const sTable = document.getElementById("sTable");
    const sCount = document.getElementById("sCount");

    function clearStudentForm(){
      sName.value=""; sGrade.value=""; sClass.value=""; sId.value="";
      sName.focus();
    }

    function addStudent(){
      const name = sName.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨Ø©."); return; }
      const student = {
        id: uid(),
        name,
        grade: sGrade.value,
        className: sClass.value.trim(),
        sid: sId.value.trim()
      };
      state.students.unshift(student);
      saveState();
      clearStudentForm();
      renderStudents();
      refreshAll();
    }

    function renderStudents(){
      sCount.textContent = state.students.length;
      sTable.innerHTML = "";
      state.students.forEach((s, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${s.name}</td>
          <td>${s.grade || "â€”"}</td>
          <td>${s.className || "â€”"}</td>
          <td>${s.sid || "â€”"}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${s.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger" data-act="del" data-id="${s.id}">Ø­Ø°Ù</button>
          </td>
        `;
        sTable.appendChild(tr);
      });
    }

    sTable.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;

      if(act==="del"){
        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨Ø©ØŸ")) return;
        state.students = state.students.filter(x=>x.id!==id);
        saveState();
        renderStudents();
        refreshAll();
      }

      if(act==="edit"){
        const s = state.students.find(x=>x.id===id);
        if(!s) return;
        sName.value = s.name;
        sGrade.value = s.grade || "";
        sClass.value = s.className || "";
        sId.value = s.sid || "";

        const addBtn = document.getElementById("sAdd");
        addBtn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        addBtn.classList.add("warn");
        addBtn.onclick = ()=>{
          s.name = sName.value.trim() || s.name;
          s.grade = sGrade.value;
          s.className = sClass.value.trim();
          s.sid = sId.value.trim();
          saveState();
          renderStudents();
          refreshAll();
          clearStudentForm();
          addBtn.textContent = "Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨Ø©";
          addBtn.classList.remove("warn");
          addBtn.onclick = addStudent;
        };
      }
    });

    document.getElementById("sAdd").onclick = addStudent;
    document.getElementById("sClear").onclick = clearStudentForm;

    /***********************
     * Attendance CRUD
     ***********************/
    const aDate = document.getElementById("aDate");
    const aGrade = document.getElementById("aGrade");
    const aPresent = document.getElementById("aPresent");
    const aAbsentExcused = document.getElementById("aAbsentExcused");
    const aAbsentUnexcused = document.getElementById("aAbsentUnexcused");
    const aNote = document.getElementById("aNote");
    const aTable = document.getElementById("aTable");
    const aCount = document.getElementById("aCount");

    function clearAttendanceForm(){
      aDate.value = todayISO_Riyadh();
      aGrade.value="";
      aPresent.value="";
      aAbsentExcused.value="";
      aAbsentUnexcused.value="";
      aNote.value="";
      aPresent.focus();
    }

    function saveAttendance(){
      const dateISO = aDate.value || todayISO_Riyadh();
      const rec = {
        id: uid(),
        dateISO,
        grade: aGrade.value.trim(),
        present: safeParseInt(aPresent.value),
        absentExcused: safeParseInt(aAbsentExcused.value),
        absentUnexcused: safeParseInt(aAbsentUnexcused.value),
        note: aNote.value.trim(),
        createdAt: Date.now()
      };

      // Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ÙŠÙ…ÙƒÙ† Ø§Ø¹ØªØ¨Ø§Ø±Ù‡ ØªØ­Ø¯ÙŠØ«Ù‹Ø§ (Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù…Ø²Ø¹Ø¬)
      const sameIndex = state.attendance.findIndex(x=> x.dateISO===rec.dateISO && (x.grade||"") === (rec.grade||""));
      if(sameIndex >= 0){
        if(confirm("ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ØµÙ. Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø¯Ù„ Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ØŸ")){
          state.attendance[sameIndex] = { ...state.attendance[sameIndex], ...rec, id: state.attendance[sameIndex].id };
        }else{
          state.attendance.unshift(rec);
        }
      }else{
        state.attendance.unshift(rec);
      }

      // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø«Ù… ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
      state.attendance.sort((a,b)=> (b.dateISO.localeCompare(a.dateISO)) || (b.createdAt - a.createdAt));

      saveState();
      clearAttendanceForm();
      renderAttendance();
      refreshAll();
      refreshAttendance();
    }

    function renderAttendance(){
      aCount.textContent = state.attendance.length;
      aTable.innerHTML = "";
      state.attendance.forEach((r, idx)=>{
        const absTotal = (r.absentExcused||0) + (r.absentUnexcused||0);
        const badge = absTotal===0 ? `<span class="tag ok">Ø§Ù†Ø¶Ø¨Ø§Ø· Ù…Ù…ØªØ§Ø²</span>`
          : absTotal<=2 ? `<span class="tag warn">ØªÙ†Ø¨ÙŠÙ‡</span>`
          : `<span class="tag bad">ØºÙŠØ§Ø¨ Ù…Ø±ØªÙØ¹</span>`;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${r.dateISO}</td>
          <td>${r.grade || "â€”"}</td>
          <td>${r.present}</td>
          <td>${r.absentExcused}</td>
          <td>${r.absentUnexcused}</td>
          <td>${(r.note || "â€”")} <div style="margin-top:6px">${badge}</div></td>
          <td>
            <button class="btn" data-act="edit" data-id="${r.id}">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn danger" data-act="del" data-id="${r.id}">Ø­Ø°Ù</button>
          </td>
        `;
        aTable.appendChild(tr);
      });
    }

    aTable.addEventListener("click", (e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.dataset.id;
      const act = btn.dataset.act;

      if(act==="del"){
        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ØŸ")) return;
        state.attendance = state.attendance.filter(x=>x.id!==id);
        saveState();
        renderAttendance();
        refreshAll();
        refreshAttendance();
        refreshReports();
      }

      if(act==="edit"){
        const r = state.attendance.find(x=>x.id===id);
        if(!r) return;
        aDate.value = r.dateISO;
        aGrade.value = r.grade || "";
        aPresent.value = r.present;
        aAbsentExcused.value = r.absentExcused;
        aAbsentUnexcused.value = r.absentUnexcused;
        aNote.value = r.note || "";

        const saveBtn = document.getElementById("aSave");
        saveBtn.textContent = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
        saveBtn.classList.add("warn");
        saveBtn.onclick = ()=>{
          r.dateISO = aDate.value || r.dateISO;
          r.grade = aGrade.value.trim();
          r.present = safeParseInt(aPresent.value);
          r.absentExcused = safeParseInt(aAbsentExcused.value);
          r.absentUnexcused = safeParseInt(aAbsentUnexcused.value);
          r.note = aNote.value.trim();
          r.createdAt = Date.now();
          state.attendance.sort((a,b)=> (b.dateISO.localeCompare(a.dateISO)) || (b.createdAt - a.createdAt));
          saveState();
          renderAttendance();
          refreshAll();
          refreshAttendance();
          refreshReports();
          clearAttendanceForm();
          saveBtn.textContent = "Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„";
          saveBtn.classList.remove("warn");
          saveBtn.onclick = saveAttendance;
        };
      }
    });

    document.getElementById("aSave").onclick = saveAttendance;
    document.getElementById("aClear").onclick = clearAttendanceForm;

    /***********************
     * Home KPIs + Today chart
     ***********************/
    function getLatestAttendanceForToday(){
      const iso = todayISO_Riyadh();
      // Ø§Ù„Ø£ÙØ¶Ù„: Ø³Ø¬Ù„ Ø§Ù„ÙŠÙˆÙ… Ø¥Ù† ÙˆØ¬Ø¯
      const todayRec = state.attendance.find(x=>x.dateISO===iso);
      if(todayRec) return todayRec;
      // ÙˆØ¥Ù„Ø§: Ø¢Ø®Ø± Ø³Ø¬Ù„
      return state.attendance[0] || null;
    }

    function refreshAll(){
      document.getElementById("kpiTeachers").textContent = state.teachers.length;
      document.getElementById("kpiStudents").textContent = state.students.length;

      const rec = getLatestAttendanceForToday();
      const present = rec ? rec.present : 0;
      const absent = rec ? ((rec.absentExcused||0)+(rec.absentUnexcused||0)) : 0;

      document.getElementById("kpiPresent").textContent = present;
      document.getElementById("kpiAbsent").textContent = absent;

      updateDoughnut(chartToday, [present, absent]);

      const total = present + absent;
      const rate = total>0 ? Math.round((present/total)*100) : 0;
      document.getElementById("todayRate").value = `${rate}%`;

      // Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©
      const noteEl = document.getElementById("adminNote");
      if(noteEl.value.trim() !== state.adminNote.trim()) noteEl.value = state.adminNote;
    }

    document.getElementById("adminNote").addEventListener("input", (e)=>{
      state.adminNote = e.target.value;
      saveState();
    });

    /***********************
     * Attendance charts
     ***********************/
    function refreshAttendance(){
      const rec = getLatestAttendanceForToday();
      const present = rec ? rec.present : 0;
      const ex = rec ? rec.absentExcused : 0;
      const un = rec ? rec.absentUnexcused : 0;

      updateDoughnut(chartAttendance, [present, ex, un]);
    }

    /***********************
     * Reports
     ***********************/
    function refreshReports(){
      const arr = state.attendance;
      const presentArr = arr.map(x=>x.present||0);
      const absentArr = arr.map(x=> (x.absentExcused||0) + (x.absentUnexcused||0));

      const avg = (xs)=> xs.length ? (xs.reduce((a,b)=>a+b,0)/xs.length) : 0;
      const max = (xs)=> xs.length ? Math.max(...xs) : 0;

      document.getElementById("kpiAvgPresent").textContent = Math.round(avg(presentArr));
      document.getElementById("kpiAvgAbsent").textContent = Math.round(avg(absentArr));
      document.getElementById("kpiMaxPresent").textContent = max(presentArr);
      document.getElementById("kpiMaxAbsent").textContent = max(absentArr);

      // Trend Ø¢Ø®Ø± 14 Ø³Ø¬Ù„
      const last = arr.slice(0,14).reverse();
      const labels = last.map(x=> x.dateISO + (x.grade?` â€¢ ${x.grade}`:""));
      const p = last.map(x=> x.present||0);
      const ab = last.map(x=> (x.absentExcused||0)+(x.absentUnexcused||0));

      chartTrend.data.labels = labels;
      chartTrend.data.datasets[0].data = p;
      chartTrend.data.datasets[1].data = ab;
      chartTrend.update();

      // Ù†Øµ ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠØ¹
      const schoolLabel = getSchoolLabel();
      const rec = getLatestAttendanceForToday();
      const iso = todayISO_Riyadh();
      const today = state.attendance.find(x=>x.dateISO===iso);
      const t = today || rec;

      let msg = `Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <b>${schoolLabel}</b><br>`;
      msg += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª: <b>${state.teachers.length}</b> â€¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª: <b>${state.students.length}</b><br>`;
      if(t){
        const abs = (t.absentExcused||0)+(t.absentUnexcused||0);
        const total = (t.present||0) + abs;
        const rate = total>0 ? Math.round((t.present/total)*100) : 0;
        msg += `Ø¢Ø®Ø± Ø­Ø¶ÙˆØ± Ù…Ø³Ø¬Ù„ (${t.dateISO}${t.grade?` - ${t.grade}`:""}): Ø­Ø¶ÙˆØ± <b>${t.present}</b> â€¢ ØºÙŠØ§Ø¨ <b>${abs}</b> â€¢ Ù†Ø³Ø¨Ø© Ø­Ø¶ÙˆØ± <b>${rate}%</b><br>`;
      }else{
        msg += `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ø¨Ø¹Ø¯.<br>`;
      }
      msg += `Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ø¯Ø§Ø±ÙŠØ©: ${state.adminNote ? `<b>${state.adminNote}</b>` : "â€”"}`;

      document.getElementById("reportText").innerHTML = msg;
    }

    /***********************
     * Settings
     ***********************/
    const schoolName = document.getElementById("schoolName");
    const schoolStage = document.getElementById("schoolStage");
    const schoolYear = document.getElementById("schoolYear");

    function getSchoolLabel(){
      const s = state.settings || {};
      const parts = [s.schoolName, s.schoolStage, s.schoolYear].filter(Boolean);
      return parts.length ? parts.join(" â€¢ ") : "â€”";
    }

    function refreshSettingsUI(){
      schoolName.value = state.settings.schoolName || "";
      schoolStage.value = state.settings.schoolStage || "";
      schoolYear.value = state.settings.schoolYear || "";
      document.getElementById("footerSchool").textContent = getSchoolLabel();
      document.getElementById("aboutText").innerHTML =
        `Ù‡Ø°Ù‡ Ù„ÙˆØ­Ø© Ù…Ø¤Ø´Ø±Ø§Øª Ù…Ø­Ù„ÙŠØ© ØªØ¹Ù…Ù„ Ø¯ÙˆÙ† Ø®Ø§Ø¯Ù… (Static).<br>
         â€¢ ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ø¨Ø± <b>localStorage</b>.<br>
         â€¢ Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub Pages ÙƒÙ…Ù„Ù <b>index.html</b>.<br>
         â€¢ ÙŠÙ…ÙƒÙ† Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¹Ø¨Ø± ØªØµØ¯ÙŠØ±/Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON.`;
    }

    document.getElementById("btnSaveSettings").onclick = ()=>{
      state.settings.schoolName = schoolName.value.trim();
      state.settings.schoolStage = schoolStage.value;
      state.settings.schoolYear = schoolYear.value.trim();
      saveState();
      refreshSettingsUI();
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
    };

    document.getElementById("btnDemoData").onclick = ()=>{
      if(!confirm("ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯.")) return;
      // Ù…Ø¹Ù„Ù…Ø§Øª
      state.teachers.unshift(
        {id:uid(), name:"Ø£. Ù†ÙˆØ±Ø© Ø£Ø­Ù…Ø¯", subject:"Ø±ÙŠØ§Ø¶ÙŠØ§Øª", phone:"0500000000", email:"noura@school.edu"},
        {id:uid(), name:"Ø£. Ø³Ø§Ø±Ø© Ø¹Ù„ÙŠ", subject:"Ø¹Ù„ÙˆÙ…", phone:"0511111111", email:"sara@school.edu"}
      );
      // Ø·Ø§Ù„Ø¨Ø§Øª
      state.students.unshift(
        {id:uid(), name:"Ø±ÙŠÙ… Ù…Ø­Ù…Ø¯", grade:"Ø§Ù„Ø³Ø§Ø¯Ø³", className:"6/Ø£", sid:""},
        {id:uid(), name:"Ù„Ù…Ù‰ Ø®Ø§Ù„Ø¯", grade:"Ø§Ù„Ø®Ø§Ù…Ø³", className:"5/Ø¨", sid:""}
      );
      // Ø­Ø¶ÙˆØ±
      const iso = todayISO_Riyadh();
      state.attendance.unshift(
        {id:uid(), dateISO:iso, grade:"Ø§Ù„Ø³Ø§Ø¯Ø³", present:26, absentExcused:1, absentUnexcused:0, note:"â€”", createdAt:Date.now()},
        {id:uid(), dateISO:iso, grade:"Ø§Ù„Ø®Ø§Ù…Ø³", present:24, absentExcused:0, absentUnexcused:2, note:"â€”", createdAt:Date.now()-20000}
      );
      state.attendance.sort((a,b)=> (b.dateISO.localeCompare(a.dateISO)) || (b.createdAt - a.createdAt));
      saveState();
      renderTeachers(); renderStudents(); renderAttendance();
      refreshAll(); refreshAttendance(); refreshReports(); refreshSettingsUI();
      alert("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©.");
    };

    /***********************
     * Topbar actions: Backup/Restore/Reset
     ***********************/
    document.getElementById("btnBackup").onclick = ()=>{
      const name = `backup-school-dashboard-${todayISO_Riyadh()}.json`;
      downloadText(name, JSON.stringify(state, null, 2));
    };

    const fileInput = document.getElementById("fileInput");
    document.getElementById("btnRestore").onclick = ()=>{
      fileInput.value = "";
      fileInput.click();
    };
    fileInput.addEventListener("change", async ()=>{
      const f = fileInput.files?.[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const parsed = JSON.parse(txt);
        if(!confirm("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ")) return;
        state = {
          ...structuredClone(defaultState),
          ...parsed,
          settings: { ...defaultState.settings, ...(parsed.settings||{}) }
        };
        saveState();
        renderTeachers(); renderStudents(); renderAttendance();
        refreshAll(); refreshAttendance(); refreshReports(); refreshSettingsUI();
        alert("ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
      }catch(e){
        alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù JSON ØµØ­ÙŠØ­.");
      }
    });

    document.getElementById("btnReset").onclick = ()=>{
      if(!confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = structuredClone(defaultState);
      saveState();
      renderTeachers(); renderStudents(); renderAttendance();
      refreshAll(); refreshAttendance(); refreshReports(); refreshSettingsUI();
    };

    /***********************
     * Quick Add Dialog + other dialogs
     ***********************/
    const dlgQuick = document.getElementById("dlgQuick");
    document.getElementById("btnQuickAdd").onclick = ()=> dlgQuick.showModal();

    document.getElementById("qaTeacher").onclick = ()=>{
      dlgQuick.close();
      setTab("teachers");
      setTimeout(()=> tName.focus(), 150);
    };
    document.getElementById("qaStudent").onclick = ()=>{
      dlgQuick.close();
      setTab("students");
      setTimeout(()=> sName.focus(), 150);
    };
    document.getElementById("qaAttendance").onclick = ()=>{
      dlgQuick.close();
      setTab("attendance");
      setTimeout(()=> aPresent.focus(), 150);
    };

    document.getElementById("btnOpenTips").onclick = ()=> document.getElementById("dlgTips").showModal();
    document.getElementById("btnOpenAbout").onclick = ()=>{
      refreshSettingsUI();
      document.getElementById("dlgAbout").showModal();
    };

    /***********************
     * Reports actions
     ***********************/
    document.getElementById("btnPrint").onclick = ()=>{
      setTab("reports");
      setTimeout(()=> window.print(), 250);
    };

    document.getElementById("btnCSV").onclick = ()=>{
      const rows = [
        ["Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„ØµÙ","Ø­Ø¶ÙˆØ±","ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±","ØºÙŠØ§Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±","Ù…Ù„Ø§Ø­Ø¸Ø©"]
      ];
      state.attendance.forEach(r=>{
        rows.push([r.dateISO, r.grade||"", r.present, r.absentExcused, r.absentUnexcused, r.note||""]);
      });
      const csv = toCSV(rows);
      downloadText(`attendance-${todayISO_Riyadh()}.csv`, csv);
    };

    /***********************
     * Initial render
     ***********************/
    renderTeachers();
    renderStudents();
    renderAttendance();
    refreshSettingsUI();
    refreshAll();
    refreshAttendance();
    refreshReports();
    clearAttendanceForm();
  </script>
</body>
</html>
